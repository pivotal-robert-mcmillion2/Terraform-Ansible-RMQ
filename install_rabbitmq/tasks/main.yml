---
- name: Install prerequisites
  apt:
    name: "{{ item }}"
    update_cache: yes
    state: present
  with_items:
   - apt-transport-https
   # - ca-certificates
   # - python3-pip
   - curl
   - software-properties-common

- name: Install bintray Key
  apt_key:
    url: https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
    state: present
- name: Add Erlang APT Repo
  apt_repository:
    repo: 'deb https://dl.bintray.com/rabbitmq-erlang/debian xenial erlang'
- name: Add RabbitMQ APT repository
  apt_repository:
    repo: 'deb https://dl.bintray.com/rabbitmq/debian xenial main'
    # repo: 'deb http://www.rabbitmq.com/debian/ testing main'
    state: present

- name: Install RabbitMQ
  apt:
    name: rabbitmq-server


- name: enable rabbitmq plugins
  rabbitmq_plugin:
    names: rabbitmq_prometheus,rabbitmq_management,rabbitmq_federation,rabbitmq_federation_management,rabbitmq_stomp,rabbitmq_shovel,rabbitmq_shovel_management,rabbitmq_mqtt,rabbitmq_tracing
    state: enabled
  notify:
  - restart rabbitmq

- name: add user
  rabbitmq_user:
    user: "{{ item }}"
    password: "{{ ADMIN_PASS }}"
    tags: administrator,{{item}}
    vhost: /
    configure_priv: .*
    write_priv: .*
    read_priv: .*
    state: present
  with_items:
  - admin



- name: Capturing Erlang Cookie On Master
  command: "cat {{ rabbitmq_erlang_cookie_file }}"
  become: true
  register: "rabbitmq_erlang_cookie"
  when: inventory_hostname == "rabbit-node1"

- name: Setting Erlang Cookie Of Master on Non-Master
  set_fact:
    rabbitmq_erlang_cookie: "{{ hostvars['rabbit-node1']['rabbitmq_erlang_cookie']['stdout'] }}"
  when: inventory_hostname != "rabbit-node1"

- name: Copy erlang cookie
  template:
    src: erlang.cookie.j2
    dest: "{{ rabbitmq_erlang_cookie_file }}"
    owner: rabbitmq
    group: rabbitmq
    mode: 0400
    # backing up in case the need to recover
    backup: yes
  become: true
  when: inventory_hostname != "rabbit-node1"
  notify:
  - restart rabbitmq
